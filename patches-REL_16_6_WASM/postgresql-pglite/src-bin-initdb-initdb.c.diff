--- REL_16_6/src/bin/initdb/initdb.c
+++ pglite-REL_16_6/src/bin/initdb/initdb.c
@@ -81,7 +81,6 @@
 #include "mb/pg_wchar.h"
 #include "miscadmin.h"
 
-
 /* Ideally this would be in a .h file, but it hardly seems worth the trouble */
 extern const char *select_default_timezone(const char *share_path);
 
@@ -168,7 +167,11 @@
 
 
 /* internal vars */
+#if !defined(PGL_MAIN)
 static const char *progname;
+#else
+#   define dynamic_shared_memory_type idb_dynamic_shared_memory_type
+#endif
 static int	encodingid;
 static char *bki_file;
 static char *hba_file;
@@ -807,6 +810,7 @@
 static char *
 get_id(void)
 {
+#if !defined(__EMSCRIPTEN__) && !defined(__wasi__)
 	const char *username;
 
 #ifndef WIN32
@@ -817,10 +821,12 @@
 		exit(1);
 	}
 #endif
-
 	username = get_user_name_or_exit(progname);
 
 	return pg_strdup(username);
+#else
+	return pg_strdup(getenv("PGUSER"));
+#endif /* wasm */
 }
 
 static char *
@@ -1066,6 +1072,9 @@
 static const char *
 choose_dsm_implementation(void)
 {
+#if defined(__wasi__) || defined(__EMSCRIPTEN__)
+    return "posix";
+#endif
 #if defined(HAVE_SHM_OPEN) && !defined(__sun__)
 	int			ntries = 10;
 	pg_prng_state prng_state;
@@ -1598,9 +1607,11 @@
 		PG_CMD_PUTS(*line);
 		free(*line);
 	}
-
+#if !defined(PGL_INITDB_MAIN)
 	PG_CMD_CLOSE;
-
+#else
+    pgl_pclose(cmdfd);
+#endif
 	free(bki_lines);
 
 	check_ok();
@@ -1670,9 +1681,11 @@
 			if (ferror(pwf))
 				pg_fatal("could not read password from file \"%s\": %m",
 						 pwfilename);
-			else
-				pg_fatal("password file \"%s\" is empty",
+			else {
+				printf("password file \"%s\" is empty\n",
 						 pwfilename);
+                pwd1 = strdup("password");
+            }
 		}
 		fclose(pwf);
 
@@ -2615,8 +2628,13 @@
 			strlcpy(full_path, progname, sizeof(full_path));
 
 		if (ret == -1)
+#if defined(__EMSCRIPTEN__) || defined(__wasi__)
+			printf("# WARNING: program \"%s\" is needed by %s but was not found in the same directory as \"%s\"\n",
+					 "postgres", progname, full_path);
+#else
 			pg_fatal("program \"%s\" is needed by %s but was not found in the same directory as \"%s\"",
 					 "postgres", progname, full_path);
+#endif // wasm
 		else
 			pg_fatal("program \"%s\" was found by \"%s\" but was not the same version as %s",
 					 "postgres", full_path, progname);
@@ -2670,22 +2688,22 @@
 			   lc_numeric,
 			   lc_time);
 	}
-
+puts("# 2651");
 	if (!encoding)
-	{
+	{ puts("# 2653");
 		int			ctype_enc;
 
 		ctype_enc = pg_get_encoding_from_locale(lc_ctype, true);
-
+puts("# 2657");
 		/*
 		 * If ctype_enc=SQL_ASCII, it's compatible with any encoding. ICU does
 		 * not support SQL_ASCII, so select UTF-8 instead.
 		 */
 		if (locale_provider == COLLPROVIDER_ICU && ctype_enc == PG_SQL_ASCII)
 			ctype_enc = PG_UTF8;
-
+puts("# 2664");
 		if (ctype_enc == -1)
-		{
+		{ puts("# 2666");
 			/* Couldn't recognize the locale's codeset */
 			pg_log_error("could not find suitable encoding for locale \"%s\"",
 						 lc_ctype);
@@ -2694,7 +2712,7 @@
 			exit(1);
 		}
 		else if (!pg_valid_server_encoding_id(ctype_enc))
-		{
+		{ puts("# 2675");
 			/*
 			 * We recognized it, but it's not a legal server encoding. On
 			 * Windows, UTF-8 works with any locale, so we can fall back to
@@ -2717,15 +2735,17 @@
 #endif
 		}
 		else
-		{
+		{ puts("# 2698");
 			encodingid = ctype_enc;
 			printf(_("The default database encoding has accordingly been set to \"%s\".\n"),
 				   pg_encoding_to_char(encodingid));
 		}
 	}
-	else
+	else {
+   puts("# 2705");
 		encodingid = get_encoding_id(encoding);
-
+    }
+   puts("# 2706");
 	if (!check_locale_encoding(lc_ctype, encodingid) ||
 		!check_locale_encoding(lc_collate, encodingid))
 		exit(1);				/* check_locale_encoding printed the error */
@@ -3044,7 +3064,11 @@
 
 	/* Select suitable configuration settings */
 	set_null_conf();
+#if !defined(__EMSCRIPTEN__) && !defined(__wasi__)
 	test_config_settings();
+#else
+    dynamic_shared_memory_type = choose_dsm_implementation();
+#endif // wasm
 
 	/* Now create all the text config files */
 	setup_config();
@@ -3104,15 +3128,56 @@
 
 	make_postgres(cmdfd);
 
+#if !defined(PGL_INITDB_MAIN)
 	PG_CMD_CLOSE;
+#else
+    pgl_pclose(cmdfd);
+#endif
+
 
 	check_ok();
 }
 
+/* pglite entry point */
+#if defined(PGL_INITDB_MAIN)
+extern void MemoryContextInit(void);
+extern const char *PREFIX;
+extern const char *PGDATA;
+char * strcat_alloc(const char *head, const char *tail);
+void strconcat(char*p, const char *head, const char *tail);
 
 int
-main(int argc, char *argv[])
-{
+pgl_initdb_main() {
+    char tmp[1024];
+    char *pwfile = NULL;
+    char *pgdata = NULL;
+
+    strconcat(tmp, "--pwfile=", PREFIX);
+    pwfile = strcat_alloc(tmp, "/password");
+
+
+    strconcat(tmp, "--pwfile=", PREFIX);
+    pgdata = strcat_alloc("--pgdata=", PGDATA);
+
+    char *argv[] = {
+        strcat_alloc(PREFIX,"/bin/initdb"),
+    //    "--no-clean",
+        "--wal-segsize=1",
+        "-g",
+        "-E", "UTF8", "--locale=C.UTF-8", "--locale-provider=libc",
+        "-U", WASM_USERNAME, pwfile,  //"--pwfile=" WASM_PREFIX "/password",
+        pgdata, // "--pgdata=" WASM_PREFIX "/base",
+        NULL
+    };
+
+    int argc = sizeof(argv) / sizeof(char*) - 1;
+
+
+#else
+int
+main(int argc, char *argv[]) {
+#endif
+
 	static struct option long_options[] = {
 		{"pgdata", required_argument, NULL, 'D'},
 		{"encoding", required_argument, NULL, 'E'},
@@ -3171,10 +3236,16 @@
 	 */
 	setvbuf(stdout, NULL, PG_IOLBF, 0);
 
+#if defined(PGL_INITDB_MAIN)
+	progname = get_progname(argv[0]);
+//    printf("calling pg_initdb_main for %s\n", progname);
+    MemoryContextInit();
+	pg_logging_init(progname);
+#else
 	pg_logging_init(argv[0]);
 	progname = get_progname(argv[0]);
+#endif
 	set_pglocale_pgservice(argv[0], PG_TEXTDOMAIN("initdb"));
-
 	if (argc > 1)
 	{
 		if (strcmp(argv[1], "--help") == 0 || strcmp(argv[1], "-?") == 0)
@@ -3188,7 +3259,7 @@
 			exit(0);
 		}
 	}
-
+puts("# 3255:pgl_initdb_main " __FILE__);
 	/* process command-line options */
 
 	while ((c = getopt_long(argc, argv, "A:c:dD:E:gkL:nNsST:U:WX:",
@@ -3430,25 +3501,24 @@
 	set_info_version();
 
 	setup_data_file_paths();
-
 	setup_locale_encoding();
-
 	setup_text_search();
-
 	printf("\n");
 
 	if (data_checksums)
 		printf(_("Data page checksums are enabled.\n"));
 	else
 		printf(_("Data page checksums are disabled.\n"));
-
+puts("# 3505:" __FILE__);
 	if (pwprompt || pwfilename)
 		get_su_pwd();
 
 	printf("\n");
-
+puts("# 3458:" __FILE__);
 	initialize_data_directory();
-
+#if defined(PGL_INITDB_MAIN)
+    puts("# 3461: TODO: fsync_pgdata ?" __FILE__);
+#else
 	if (do_sync)
 	{
 		fputs(_("syncing data to disk ... "), stdout);
@@ -3466,7 +3536,7 @@
 		pg_log_warning_hint("You can change this by editing pg_hba.conf or using the option -A, or "
 							"--auth-local and --auth-host, the next time you run initdb.");
 	}
-
+puts("# 3480");
 	if (!noinstructions)
 	{
 		/*
@@ -3501,8 +3571,8 @@
 
 		destroyPQExpBuffer(start_db_cmd);
 	}
-
-
+#endif
 	success = true;
+puts("# 3569:" __FILE__);
 	return 0;
 }
